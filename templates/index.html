<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI海报生成器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal img {
            max-width: 90%;
            max-height: 90vh;
            object-fit: contain;
        }
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex: 1;
        }
        .footer {
            margin-top: auto;
            padding: 1rem 0;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="main-content">
        <div class="container mx-auto px-4 py-8">
            <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">AI海报生成器</h1>
            
            <div class="bg-white rounded-lg shadow-lg p-6 max-w-4xl mx-auto">
                <form id="posterForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- 标题 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">标题 <span class="text-gray-500 text-xs">(最多30字)</span></label>
                            <input type="text" name="title" maxlength="30"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- 副标题 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">副标题 <span class="text-gray-500 text-xs">(最多30字)</span></label>
                            <input type="text" name="sub_title" maxlength="30"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- 正文 -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">正文 <span class="text-gray-500 text-xs">(最多50字)</span></label>
                            <textarea name="body_text" rows="3" maxlength="50"
                                      class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>

                        <!-- 提示词 -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">提示词 <span class="text-gray-500 text-xs">(最多50字)</span></label>
                            <input type="text" name="prompt_text_zh" maxlength="50"
                                   class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- AI提示词生成 -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">AI提示词生成</label>
                            <div class="flex space-x-4">
                                <input type="text" id="aiPromptInput" placeholder="请输入产品描述，AI将帮您生成标题、副标题、正文和提示词"
                                       class="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <button type="button" id="generatePromptBtn"
                                        class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    <span class="inline-flex items-center">
                                        <span class="generate-text">生成提示词</span>
                                        <span class="loading-spinner hidden inline-flex items-center">
                                            <svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span>生成中...</span>
                                        </span>
                                    </span>
                                </button>
                            </div>
                        </div>

                        <!-- 宽高比 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">宽高比</label>
                            <select name="wh_ratios" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="横版">横版</option>
                                <option value="竖版">竖版</option>
                            </select>
                        </div>

                        <!-- 艺术风格 -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">艺术风格</label>
                            <select name="lora_name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                <option value="2D插画1">2D插画1</option>
                                <option value="2D插画2">2D插画2</option>
                                <option value="浩瀚星云">浩瀚星云</option>
                                <option value="浓郁色彩">浓郁色彩</option>
                                <option value="光线粒子">光线粒子</option>
                                <option value="透明玻璃">透明玻璃</option>
                                <option value="剪纸工艺">剪纸工艺</option>
                                <option value="折纸工艺">折纸工艺</option>
                                <option value="中国水墨">中国水墨</option>
                                <option value="中国刺绣">中国刺绣</option>
                                <option value="真实场景">真实场景</option>
                                <option value="2D卡通">2D卡通</option>
                                <option value="儿童水彩">儿童水彩</option>
                                <option value="赛博背景">赛博背景</option>
                                <option value="浅蓝抽象">浅蓝抽象</option>
                                <option value="深蓝抽象">深蓝抽象</option>
                                <option value="抽象点线">抽象点线</option>
                                <option value="童话油画">童话油画</option>
                            </select>
                        </div>
                    </div>

                    <!-- API Key -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">阿里云百炼API Key <span class="text-gray-500 text-xs">(选填，不填使用默认key)</span></label>
                        <input type="password" name="api_key"
                               class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- 生成按钮 -->
                    <div class="flex justify-center">
                        <button type="button" id="generatePosterBtn"
                                class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="inline-flex items-center">
                                <span class="generate-poster-text">生成海报</span>
                                <span class="loading-spinner-poster hidden inline-flex items-center">
                                    <svg class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span>生成中...</span>
                                </span>
                            </span>
                        </button>
                    </div>
                </form>

                <!-- 状态显示 -->
                <div id="status" class="mt-6 hidden">
                    <div class="flex flex-col items-center justify-center space-y-4">
                        <div id="pollingInfo" class="text-sm text-gray-500">
                            <span id="pollCount">轮询次数: 0</span>
                            <span class="mx-2">|</span>
                            <span id="elapsedTime">已用时间: 0秒</span>
                        </div>
                    </div>
                </div>

                <!-- 结果展示 -->
                <div id="result" class="mt-6 hidden">
                    <h2 class="text-xl font-semibold mb-4 text-center">生成结果</h2>
                    <div id="imageContainer" class="flex justify-center">
                        <!-- 图片将在这里动态显示 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 底部固定链接 -->
    <footer class="footer">
        <div class="container mx-auto px-4">
            <div class="text-center">
                <a href="https://github.com/koala9527/ai-poster" target="_blank" 
                   class="inline-flex items-center text-gray-500 hover:text-gray-900 transition-colors">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                    GitHub 项目地址
                </a>
            </div>
        </div>
    </footer>

    <!-- 图片预览模态框 -->
    <div id="imageModal" class="modal">
        <img id="modalImage" src="" alt="预览图片">
    </div>

    <script>
        let startTime = null;
        let pollCount = 0;
        let pollInterval = null;
        let generatePromptTimeout = null;
        let generatePosterTimeout = null;

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 更新生成提示词按钮状态
        function updateGeneratePromptButton(isLoading) {
            const button = document.getElementById('generatePromptBtn');
            const generateText = button.querySelector('.generate-text');
            const loadingSpinner = button.querySelector('.loading-spinner');
            
            button.disabled = isLoading;
            if (isLoading) {
                generateText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                generateText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        // 更新生成海报按钮状态
        function updateGeneratePosterButton(isLoading) {
            const button = document.getElementById('generatePosterBtn');
            const generateText = button.querySelector('.generate-poster-text');
            const loadingSpinner = button.querySelector('.loading-spinner-poster');
            
            button.disabled = isLoading;
            if (isLoading) {
                generateText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                generateText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        function updateElapsedTime() {
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('elapsedTime').textContent = `已用时间: ${elapsed}秒`;
            }
        }

        function startPollingTimer() {
            startTime = Date.now();
            pollCount = 0;
            updateElapsedTime();
            pollInterval = setInterval(updateElapsedTime, 1000);
        }

        function stopPollingTimer() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // 图片预览功能
        function showImagePreview(imageUrl) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modalImg.src = imageUrl;
            modal.style.display = 'flex';
        }

        // 关闭预览
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });

        // 生成海报的主要函数
        const generatePoster = async () => {
            const form = document.getElementById('posterForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            
            // 验证必填字段
            const requiredFields = ['title', 'sub_title', 'body_text', 'prompt_text_zh', 'wh_ratios', 'lora_name'];
            const missingFields = requiredFields.filter(field => !data[field]);
            
            if (missingFields.length > 0) {
                alert(`请填写以下必填字段：${missingFields.join(', ')}`);
                return;
            }
            
            // 显示状态
            document.getElementById('status').classList.remove('hidden');
            document.getElementById('result').classList.add('hidden');
            startPollingTimer();
            updateGeneratePosterButton(true);
            
            try {
                // 发送生成请求
                const response = await axios.post('/generate', data, {
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                
                if (response.data.error) {
                    throw new Error(response.data.error);
                }
                
                const taskId = response.data.task_id;
                
                // 开始轮询任务状态
                pollTaskStatus(taskId);
            } catch (error) {
                console.error('Error:', error);
                alert(error.response?.data?.error || error.message || '生成失败，请重试');
                document.getElementById('status').classList.add('hidden');
                stopPollingTimer();
                updateGeneratePosterButton(false);
            }
        };

        // 使用防抖包装生成海报函数
        const debouncedGeneratePoster = debounce(generatePoster, 500);

        // 添加按钮点击事件
        document.getElementById('generatePosterBtn').addEventListener('click', debouncedGeneratePoster);

        async function pollTaskStatus(taskId) {
            try {
                const response = await axios.get(`/status/${taskId}`);
                
                if (response.data.error) {
                    throw new Error(response.data.error);
                }
                
                const status = response.data.status;
                pollCount++;
                document.getElementById('pollCount').textContent = `轮询次数: ${pollCount}`;
                
                if (status === 'SUCCEEDED') {
                    // 显示结果
                    document.getElementById('status').classList.add('hidden');
                    document.getElementById('result').classList.remove('hidden');
                    stopPollingTimer();
                    updateGeneratePosterButton(false);
                    
                    const imageContainer = document.getElementById('imageContainer');
                    imageContainer.innerHTML = '';
                    
                    // 显示生成的图片
                    if (response.data.result && response.data.result.image_url) {
                        const img = document.createElement('img');
                        img.src = response.data.result.image_url;
                        img.alt = '生成的海报';
                        img.className = 'max-w-full h-auto rounded-lg shadow-md cursor-pointer hover:opacity-90 transition-opacity';
                        img.onclick = () => showImagePreview(response.data.result.image_url);
                        imageContainer.appendChild(img);
                    } else {
                        throw new Error('未获取到图片URL');
                    }
                } else if (status === 'FAILED') {
                    alert('生成失败：' + (response.data.error_message || '未知错误'));
                    document.getElementById('status').classList.add('hidden');
                    stopPollingTimer();
                    updateGeneratePosterButton(false);
                } else {
                    // 继续轮询
                    setTimeout(() => pollTaskStatus(taskId), 2000);
                }
            } catch (error) {
                console.error('Error polling status:', error);
                alert(error.response?.data?.error || error.message || '获取状态失败，请重试');
                document.getElementById('status').classList.add('hidden');
                stopPollingTimer();
                updateGeneratePosterButton(false);
            }
        }

        // 字符限制处理函数
        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) : text;
        }

        // AI提示词生成功能
        const generatePrompt = async () => {
            const aiPromptInput = document.getElementById('aiPromptInput');
            const productDesc = aiPromptInput.value.trim();
            
            if (!productDesc) {
                alert('请输入产品描述');
                return;
            }

            updateGeneratePromptButton(true);

            try {
                const response = await axios.post('/generate_prompt', {
                    product_desc: productDesc
                });

                if (response.data.error) {
                    throw new Error(response.data.error);
                }

                // 填充生成的文本并进行长度限制
                document.querySelector('input[name="title"]').value = truncateText(response.data.title, 30);
                document.querySelector('input[name="sub_title"]').value = truncateText(response.data.sub_title, 30);
                document.querySelector('textarea[name="body_text"]').value = truncateText(response.data.body_text, 50);
                document.querySelector('input[name="prompt_text_zh"]').value = truncateText(response.data.prompt_text_zh, 50);
            } catch (error) {
                console.error('Error:', error);
                alert(error.response?.data?.error || error.message || '生成提示词失败，请重试');
            } finally {
                updateGeneratePromptButton(false);
            }
        };

        // 使用防抖包装生成函数
        const debouncedGeneratePrompt = debounce(generatePrompt, 500);

        // 添加按钮点击事件
        document.getElementById('generatePromptBtn').addEventListener('click', debouncedGeneratePrompt);
    </script>
</body>
</html> 